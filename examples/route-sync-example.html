<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chekin SDK - Route Synchronization Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .demo-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007cba;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #005a8a;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .route-display {
            font-family: monospace;
            background-color: #f8f8f8;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
        }
        #chekin-container {
            width: 100%;
            min-height: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chekin SDK - Route Synchronization Demo</h1>
        <p>This example demonstrates bidirectional route synchronization between the parent window and the Chekin SDK iframe.</p>
        
        <div class="status">
            <strong>Current Parent Route:</strong>
            <div class="route-display" id="parent-route">Not synced</div>
        </div>

        <div class="demo-controls">
            <button onclick="initializeSDK()">Initialize SDK</button>
            <p style="margin: 10px 0; padding: 10px; background: #e8f5e8; border-radius: 4px; border: 1px solid #4caf50;">
                <strong>✨ Route sync is automatic!</strong> No need to manually enable it.
            </p>
        </div>

        <div class="demo-controls">
            <h3>Test Automatic Navigation:</h3>
            <button onclick="setParentHash('/guests')">Parent → Guests</button>
            <button onclick="setParentHash('/reservations')">Parent → Reservations</button>
            <button onclick="setParentHash('/settings')">Parent → Settings</button>
            <button onclick="setParentHash('/')">Parent → Home</button>
        </div>

        <div class="demo-controls">
            <h3>Manual Hash Change:</h3>
            <button onclick="setHash('#chekin=/manual-test')">Set Manual Hash</button>
            <button onclick="clearHash()">Clear Hash</button>
        </div>
    </div>

    <div class="container">
        <h2>SDK Container</h2>
        <div id="chekin-container">
            <p style="text-align: center; margin-top: 50px; color: #666;">
                Click "Initialize SDK" to load the Chekin iframe
            </p>
        </div>
    </div>

    <script type="module">
        // Import the SDK (this would normally be from a CDN or npm package)
        // For demo purposes, we'll simulate the SDK
        let sdk = null;
        let routeSyncEnabled = false;

        window.initializeSDK = async function() {
            try {
                // Simulate SDK initialization
                const container = document.getElementById('chekin-container');
                container.innerHTML = '<p style="text-align: center; margin-top: 50px;">Loading SDK...</p>';
                
                // Create iframe pointing to the host-sdk app
                const iframe = document.createElement('iframe');
                iframe.src = 'http://localhost:4200?apiKey=demo-key&features=guests,reservations';
                iframe.style.cssText = 'width: 100%; height: 600px; border: none;';
                iframe.sandbox = 'allow-modals allow-forms allow-popups allow-scripts allow-same-origin';
                
                container.innerHTML = '';
                container.appendChild(iframe);
                
                // Simulate SDK object with automatic route sync
                sdk = {
                    iframe: iframe,
                    routeSyncEnabled: true, // Auto-enabled
                    hashPrefix: 'chekin',
                    currentRoute: '/',
                    
                    handleHashChange: function() {
                        if (!this.routeSyncEnabled) return;
                        
                        const hash = window.location.hash.slice(1);
                        const routeMatch = hash.match(new RegExp(`^${this.hashPrefix}=(.+)`));
                        
                        if (routeMatch) {
                            const route = decodeURIComponent(routeMatch[1]);
                            this.syncRouteToIframe(route);
                        }
                    },
                    
                    handleMessage: function(event) {
                        if (event.source !== this.iframe.contentWindow) return;
                        
                        if (event.data.type === 'route-changed' && this.routeSyncEnabled) {
                            const route = event.data.payload.route;
                            this.updateParentHash(route);
                        }
                    },
                    
                    syncRouteToIframe: function(route) {
                        this.currentRoute = route;
                        this.iframe.contentWindow.postMessage({
                            type: 'route-sync',
                            payload: { route }
                        }, 'https://cdn.chekin.com');
                        updateParentRouteDisplay(route);
                    },
                    
                    updateParentHash: function(route) {
                        const encodedRoute = encodeURIComponent(route);
                        const newHash = `#${this.hashPrefix}=${encodedRoute}`;
                        window.history.replaceState(null, '', newHash);
                        this.currentRoute = route;
                        updateParentRouteDisplay(route);
                    },
                    
                    initializeFromHash: function() {
                        const hash = window.location.hash.slice(1);
                        const routeMatch = hash.match(new RegExp(`^${this.hashPrefix}=(.+)`));
                        
                        if (routeMatch) {
                            const route = decodeURIComponent(routeMatch[1]);
                            this.syncRouteToIframe(route);
                        }
                    },
                    
                    navigateToRoute: function(route) {
                        this.syncRouteToIframe(route);
                        this.updateParentHash(route);
                    }
                };
                
                // Auto-initialize route sync
                window.addEventListener('hashchange', sdk.handleHashChange.bind(sdk));
                window.addEventListener('message', sdk.handleMessage.bind(sdk));
                sdk.initializeFromHash();
                
                console.log('SDK initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize SDK:', error);
            }
        };

        window.setParentHash = function(route) {
            if (!sdk) return;
            sdk.navigateToRoute(route);
        };

        window.setHash = function(hash) {
            window.location.hash = hash;
        };

        window.clearHash = function() {
            window.location.hash = '';
            updateParentRouteDisplay('Not synced');
        };

        function updateParentRouteDisplay(route) {
            document.getElementById('parent-route').textContent = route;
        }

        // Monitor hash changes for display
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash;
            if (hash.includes('chekin=')) {
                const route = decodeURIComponent(hash.split('chekin=')[1]);
                updateParentRouteDisplay(route);
            }
        });
    </script>
</body>
</html>